<!DOCTYPE html>
<html xmlns = "http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<title>MyMusiPiano Tutor</title>
	<link href="examples/css/MIDIPlayer.css" rel="stylesheet" type="text/css" />
	<link href="//fonts.googleapis.com/css?family=Oswald" rel="stylesheet" type="text/css" />
	<link href="//fonts.googleapis.com/css?family=Andada" rel="stylesheet" type="text/css" />
	<!-- jasmid package -->
	<script src="inc/jasmid/stream.js"></script>
	<script src="inc/jasmid/midifile.js"></script>
	<script src="inc/jasmid/replayer.js"></script>
	<!-- shim -->
	<script src="inc/shim/Base64.js" type="text/javascript"></script>
	<script src="inc/shim/Base64binary.js" type="text/javascript"></script>
	<script src="inc/shim/WebAudioAPI.js" type="text/javascript"></script>
	<script src="inc/shim/WebMIDIAPI.js" type="text/javascript"></script>
	<!-- midi.js package -->
	<script src="js/midi/audioDetect.js" type="text/javascript"></script>
	<script src="js/midi/gm.js" type="text/javascript"></script>
	<script src="js/midi/loader.js" type="text/javascript"></script>
	<script src="js/midi/plugin.audiotag.js" type="text/javascript"></script>
	<script src="js/midi/plugin.webaudio.js" type="text/javascript"></script>
	<script src="js/midi/plugin.webmidi.js" type="text/javascript"></script>
	<script src="js/midi/player.js" type="text/javascript"></script>
	<script src="js/midi/synesthesia.js" type="text/javascript"></script>
	<!-- utils -->
	<script src="js/util/dom_request_xhr.js" type="text/javascript"></script>
	<script src="js/util/dom_request_script.js" type="text/javascript"></script>
	<!-- includes -->
	<script src="examples/inc/timer.js" type="text/javascript"></script>
	<script src="examples/inc/colorspace.js" type="text/javascript"></script>
	<script src="examples/inc/event.js" type="text/javascript"></script>
</head>
<body>
<script type="text/javascript">
	window.onload = function () {
		
		// Create small piano for title
		var black_title_row = document.getElementById("tr_piano_black_title");
		var white_title_row = document.getElementById("tr_piano_white_title");
		var black_title = ['T', 'U', 'T', 'O', 'R', 'I', 'A', 'L'];
		var black_spacing = ["16px", "12px" , "12px" ,"32px" ,"12px" ,"32px" ,"12px" ,"12px"];
		var white_title = ['M', 'Y', 'M', 'U', 'S', 'I', 'P', 'I', 'A', 'N', 'O'];
		//Add the black keys in the piano
		for (var i = 0; i < black_title.length; i++) {
			//Add spacing between the black keys
			var extra_key = document.createElement("td");
			extra_key.style.width = black_spacing[i];
			black_title_row.appendChild(extra_key);
			//Now add the black key
			var black_key = document.createElement("td");
			black_key.style.color = "white";
			black_key.style.fontSize = "x-small";
			white_key.style.verticalAlign = "bottom";
			black_key.style.background = "black";
			black_key.innerHTML = black_title[i];
			black_key.style.width = "8px";
			black_title_row.appendChild(black_key);
		}
		//Finally add the last extra space
		var final_extra_key = document.createElement("td");
		final_extra_key.style.width = "16px";
		black_title_row.appendChild(final_extra_key);
		
		//Now add the white keys in the piano
		for(var j = 0; j < white_title.length; j++) {
			var white_key = document.createElement("td");
			white_key.style.border = "1px solid black";
			white_key.style.width = "20px";
			white_key.style.background = "white";
			white_key.style.fontSize="x-small";
			white_key.style.color = "black";
			white_key.style.verticalAlign = "bottom";
			white_key.innerHTML = white_title[j];
			white_title_row.appendChild(white_key);
		}
		
		
		// Create the 88 key piano
		var black_keys = document.getElementById("tr_piano_black");
		var white_keys = document.getElementById("tr_piano_white");
		var colorElements = [];
		for (var n = 0; n < 88; n++) {
			var keyName = MIDI.noteToKey[n + 21];
			// If it is a black key, then the name contains 'b' (flat)
			if(keyName.indexOf("b") != -1) {
				//Create a white extra column and the black column for a black key
				var b_extra = document.createElement("td");
				// Db and Gb have a different column width for white space
				//console.log(keyName);
				if(keyName.indexOf("Db") != -1 || keyName.indexOf("Gb") != -1) {
					
					if(keyName.indexOf("4") != -1 || keyName.indexOf("5") != -1 || keyName.indexOf("6") != -1) {
						b_extra.style.width = "32px";
					} else {
						b_extra.style.width = "33px";
					}	
				} else if(keyName.indexOf("Bb0") != -1) {
				        b_extra.style.width = "16px";
				}
				else {	   
					b_extra.style.width = "12px";
				}
				black_keys.appendChild(b_extra);
				var d = document.createElement("td");
				d.style.background = "black";
				d.style.width = "8px";
				black_keys.appendChild(d);
			}
			else{
				var d = document.createElement("td");
				d.style.border = "1px solid grey";
				d.style.background = "white";
				d.style.width = "20px";
				white_keys.appendChild(d);
			}
			
			colorElements.push(d);
		}
		///
		MIDI.loader = new sketch.ui.Timer;
		MIDI.loadPlugin({
			soundfontUrl: "examples/soundfont/",
			instrument: "acoustic_grand_piano",
			onprogress: function(state, progress) {
				MIDI.loader.setValue(progress * 100);
			},
			onsuccess: function() {
				/// this sets up the MIDI.Player and gets things going...
				player = MIDI.Player;
				player.timeWarp = 1; // speed the song is played back
				player.loadFile("mamathala_talli.mid", player.start);
				/// control the piano keys colors
				var colorMap = MIDI.Synesthesia.map();
				player.addListener(function(data) {
					var pianoKey = data.note - 21;
					var d = colorElements[pianoKey];
					if (d) {
						if (data.message === 144) {
							var map = colorMap[data.note - 27];
							if (map) d.style.background = map.hex;
							
							d.style.color = "#fff";
						} else {
							//Black key 
							if(MIDI.noteToKey[data.note].indexOf("b") != -1) {
								d.style.background = "black";
							} else {
								d.style.background = "white";
							}
							d.style.color = "";
						}
					}
				});
				///
				//ColorSphereBackground();
				//MIDIPlayerPercentage(player);
			}
		});
	};
	
</script>
	<div id="title" style="align: center; margin:auto; width: 100%; padding:50px;">
		<table id="white_table_title" style="border-collapse: collapse; border: 1px solid grey; width:220px; height: 80px; table-layout: fixed;">
			 <tr id="tr_piano_white_title">
			 </tr>
		</table>
		<table id="black_table_title" style="border-collapse: collapse; border: 0px; width:220px; height: 50px; margin-top: -80px; table-layout: fixed;">
			  <tr id="tr_piano_black_title">
			  </tr>	 
		</table>
	</div>
	<div style="text-align: center; margin:auto; width: 100%; padding: 50px;">
		<table id="white_table" style="border-collapse: collapse; border: 1px solid grey; width:1040px; height: 80px; table-layout: fixed;">
			 <tr id="tr_piano_white"></tr>
		</table>
		<table id="black_table" style="border-collapse: collapse; border: 0px; width:1040px; height: 50px; margin-top: -80px; table-layout: fixed;">
			  <tr id="tr_piano_black"></tr>	 
		</table>
	</div>
	
</body>
</html>
