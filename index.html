<!DOCTYPE html>
<html xmlns = "http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<title>MyMusiPiano Tutor</title>
	<link href="examples/css/MIDIPlayer.css" rel="stylesheet" type="text/css" />
	<link href="//fonts.googleapis.com/css?family=Oswald" rel="stylesheet" type="text/css" />
	<link href="//fonts.googleapis.com/css?family=Andada" rel="stylesheet" type="text/css" />
	<!-- jasmid package -->
	<script src="inc/jasmid/stream.js"></script>
	<script src="inc/jasmid/midifile.js"></script>
	<script src="inc/jasmid/replayer.js"></script>
	<!-- shim -->
	<script src="inc/shim/Base64.js" type="text/javascript"></script>
	<script src="inc/shim/Base64binary.js" type="text/javascript"></script>
	<script src="inc/shim/WebAudioAPI.js" type="text/javascript"></script>
	<script src="inc/shim/WebMIDIAPI.js" type="text/javascript"></script>
	<!-- midi.js package -->
	<script src="js/midi/audioDetect.js" type="text/javascript"></script>
	<script src="js/midi/gm.js" type="text/javascript"></script>
	<script src="js/midi/loader.js" type="text/javascript"></script>
	<script src="js/midi/plugin.audiotag.js" type="text/javascript"></script>
	<script src="js/midi/plugin.webaudio.js" type="text/javascript"></script>
	<script src="js/midi/plugin.webmidi.js" type="text/javascript"></script>
	<script src="js/midi/player.js" type="text/javascript"></script>
	<script src="js/midi/synesthesia.js" type="text/javascript"></script>
	<!-- utils -->
	<script src="js/util/dom_request_xhr.js" type="text/javascript"></script>
	<script src="js/util/dom_request_script.js" type="text/javascript"></script>
	<!-- includes -->
	<script src="examples/inc/timer.js" type="text/javascript"></script>
	<script src="examples/inc/colorspace.js" type="text/javascript"></script>
	<script src="examples/inc/event.js" type="text/javascript"></script>
</head>
<body>
<script type="text/javascript">
	window.onload = function () {
		
		// Create each column as a piano key initially
		var black_keys = document.getElementById("tr_piano_black");
		var white_keys = document.getElementById("tr_piano_white");
		var colorElements = [];
		for (var n = 0; n < 88; n++) {
			var keyName = MIDI.noteToKey[n + 21];
			// If it is a black key, then the name contains 'b' (flat)
			if(keyName.indexOf("b") != -1) {
				//Create a white extra column and the black column for a black key
				var b_extra = document.createElement("td");
				b_extra.style.border = "1px solid grey";
				// Db and Gb have a different column width for white space
				console.log(keyName);
				if(keyName.indexOf("Db") != -1 || keyName.indexOf("Gb") != -1) {
					b_extra.style.width = "14px";
				} else {	   
					b_extra.style.width = "7px";
				}
				black_keys.appendChild(b_extra);
				var d = document.createElement("td");
				d.style.background = "black";
				d.style.width = "4px";
				black_keys.appendChild(d);
			}
			else{
				var d = document.createElement("td");
				d.style.border = "1px solid grey";
				d.style.background = "white";
				d.style.width = "10px";
				white_keys.appendChild(d);
			}
			
			colorElements.push(d);
		}
		///
		MIDI.loader = new sketch.ui.Timer;
		MIDI.loadPlugin({
			soundfontUrl: "examples/soundfont/",
			instrument: "acoustic_grand_piano",
			onprogress: function(state, progress) {
				MIDI.loader.setValue(progress * 100);
			},
			onsuccess: function() {
				/// this sets up the MIDI.Player and gets things going...
				player = MIDI.Player;
				player.timeWarp = 1; // speed the song is played back
				player.loadFile("test_midi_1.mid", player.start);
				/// control the piano keys colors
				var colorMap = MIDI.Synesthesia.map();
				player.addListener(function(data) {
					var pianoKey = data.note - 21;
					var d = colorElements[pianoKey];
					if (d) {
						if (data.message === 144) {
							var map = colorMap[data.note - 27];
							if (map) d.style.background = map.hex;
							d.style.color = "#fff";
						} else {
							//Black key 
							if(MIDI.noteToKey[data.note].indexOf("b") != -1) {
								d.style.background = "black";
							} else {
								d.style.background = "white";
							}
							d.style.color = "";
						}
					}
				});
				///
				//ColorSphereBackground();
				//MIDIPlayerPercentage(player);
			}
		});
	};
	
</script>
	<div style="text-align: center; position: absolute; top: 50px; left: 50px;" id="colors">
		<table id="black_table" style="border-collapse: collapse; border: 1px solid grey; width:880px; height: 40px;">
			  <tr id="tr_piano_black"></tr>	 
		</table>
		<table id="white_table" style="border-collapse: collapse; border: 1px solid grey; width:880px; height: 50px;">
			 <tr id="tr_piano_white"></tr>
		</table>
	</div>
	
</body>
</html>
